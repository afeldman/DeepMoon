#!/usr/bin/env python

import os, sys

import torch

if __debug__:
    scriptPath = os.path.realpath(os.path.dirname(__file__))
    sys.path.append(scriptPath + "/..")

from pathlib import Path
import click
from PIL import Image
from random import shuffle
from tqdm import tqdm

import torchvision.transforms as transforms

from deepmoon.learning.model import Crater_VNet


@click.command(context_settings=dict(help_option_names=['-h', '--help']))
@click.argument("image_files")
@click.argument("checkpoint")
@click.argument("output")
def main(image_files, checkpoint, output):
      image_files = Path(image_files)
      checkpoint = Path(checkpoint)
      output = Path(output)

      if not output.is_dir():
            output.mkdir(exist_ok=True, parents=True)

      if not checkpoint.is_file():
            raise SystemExit(f"checkpoint not found")

      location= torch.device('cuda') if torch.cuda.is_available() else torch.device("cpu")
      model = Crater_VNet.load_from_checkpoint(checkpoint,map_location=location)
      model.eval()

      file_list = [item for item in image_files.iterdir() if not item.absolute().is_dir()][::3]
      shuffle(file_list)

      for image in tqdm(file_list):
            input_image = Image.open(image.absolute())
            tensor = transforms.ToTensor()(input_image).unsqueeze(0)
            predictions = model(tensor)

            eval_img = transforms.ToPILImage()(predictions.squeeze()).convert("L")
            eval_img.save(output / f"{image.stem}_eval.png")

            input_image = Image.blend(input_image, eval_img, alpha=0.2)
            input_image.save(output / f"{image.stem}_img.png")

if __name__=="__main__":
      main()
         